<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="icon" type="image/png" href="/favicon.png">
  <title>CineVibe - Movie Mood Curator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* ---------- Reset / Base ---------- */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: 'Inter', sans-serif; color: var(--text-primary); background: var(--gradient-bg); background-attachment: fixed; overflow-x: hidden; }

    :root{
      --bg-primary: hsl(240, 15%, 6%);
      --bg-secondary: hsl(240, 12%, 9%);
      --bg-card: hsl(240, 10%, 12%);
      --bg-glass: rgba(20, 20, 30, 0.8);

      --text-primary: hsl(0, 0%, 95%);
      --text-secondary: hsl(240, 5%, 70%);
      --text-muted: hsl(240, 5%, 50%);

      --primary-start: hsl(280, 100%, 60%);
      --primary-end: hsl(320, 100%, 70%);
      --primary-glow: hsl(300, 100%, 80%);

      --accent-cyan: hsl(180, 100%, 60%);
      --accent-blue: hsl(220, 100%, 65%);
      --accent-green: hsl(120, 100%, 60%);

      --border-color: hsl(240, 10%, 20%);
      --border-glow: hsl(240, 10%, 30%);

      --gradient-primary: linear-gradient(135deg, var(--primary-start), var(--primary-end));
      --gradient-glow: linear-gradient(135deg, var(--primary-start), var(--primary-end), var(--accent-cyan));
      --gradient-bg: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-card) 100%);

      --shadow-neon: 0 0 30px rgba(200, 50, 255, 0.3);
      --shadow-card: 0 10px 40px rgba(0, 0, 0, 0.4);
      --shadow-intense: 0 0 50px rgba(200, 50, 255, 0.5);

      --space-1: clamp(0.25rem, 1vw, 0.5rem);
      --space-2: clamp(0.5rem, 1.2vw, 0.75rem);
      --space-3: clamp(0.75rem, 1.6vw, 1rem);
      --space-4: clamp(1rem, 2vw, 1.25rem);
      --space-5: clamp(1.25rem, 3vw, 2rem);
      --radius: 0.75rem;
      --radius-lg: 1rem;
    }

    body::before {
      content: '';
      position: fixed; inset: 0;
      background:
        radial-gradient(circle at 20% 80%, rgba(200, 50, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(50, 200, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 50, 150, 0.05) 0%, transparent 50%);
      pointer-events: none; z-index: -1;
      animation: backgroundFloat 20s ease-in-out infinite;
    }
    @keyframes backgroundFloat { 0%,100%{ transform: translateY(0) } 33%{ transform: translateY(-12px) } 66%{ transform: translateY(8px) } }

    /* ---------- Navbar ---------- */
    .navbar{
      position: sticky; top: 0; z-index: 50;
      background: var(--bg-glass); backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-color);
      padding: var(--space-2) var(--space-4);
      display: flex; align-items: center; justify-content: space-between;
      gap: var(--space-2);
    }
    .logo{ display:flex; align-items:center; gap: .75rem; cursor:pointer; user-select:none; }
    .logo-icon{
      width: 2.25rem; height: 2.25rem; border-radius: .7rem;
      background: var(--gradient-primary); color:#fff; font-weight:800;
      display:flex; align-items:center; justify-content:center;
      box-shadow: var(--shadow-neon); animation: logoPulse 3s ease-in-out infinite;
    }
    @keyframes logoPulse { 0%,100%{ box-shadow: var(--shadow-neon)} 50%{ box-shadow: var(--shadow-intense)} }
    .logo-text{
      font-family: 'Space Grotesk', sans-serif;
      font-size: clamp(1.1rem, 2.8vw, 1.5rem);
      font-weight: 800;
      background: var(--gradient-primary);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip:text;
      transition: transform .2s ease, opacity .2s ease;
    }
    .logo:hover .logo-text{ opacity:.9; transform: scale(1.02); }

    .nav-actions{
      display:flex; align-items:center; gap: .5rem; flex-wrap: wrap;
      justify-content: flex-end; max-width: 100%;
    }
    .history-button, .logout-button{
      padding: .55rem .8rem; font-size: .9rem;
      background: transparent; border: 1px solid var(--border-color);
      border-radius: .6rem; color: var(--text-secondary);
      cursor: pointer; transition: all .25s ease; white-space: nowrap;
    }
    .history-button:hover, .logout-button:hover{ border-color: var(--accent-cyan); color: var(--accent-cyan); box-shadow: 0 0 18px rgba(50,200,255,.25); }
    #musicVolume{
      width: clamp(90px, 22vw, 140px); accent-color: hsl(280 100% 65%);
    }

    @media (max-width: 480px){
      .nav-actions{ gap: .4rem; }
      .history-button, .logout-button{ padding: .5rem .65rem; font-size: .85rem; }
    }

    /* ---------- Layout ---------- */
    .container{ max-width: 1200px; margin-inline:auto; padding: var(--space-4); }
    @media (max-width: 768px){ .container{ padding: var(--space-3); } }

    .hero-section{ text-align:center; margin-bottom: var(--space-5); }
    .hero-title{
      font-family:'Space Grotesk',sans-serif;
      font-size: clamp(2rem, 6.5vw, 4.5rem);
      font-weight: 800; margin-bottom: .6rem;
      background: var(--gradient-glow);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
      animation: fadeInUp .8s ease-out both;
      position: relative;
    }
    .hero-title::after{
      content:''; position:absolute; bottom:-10px; left:50%; transform:translateX(-50%);
      width: clamp(70px, 14vw, 120px); height: 3px; border-radius:2px;
      background: var(--gradient-primary); opacity: .7;
    }
    .hero-subtitle{
      font-size: clamp(.95rem, 2.7vw, 1.15rem);
      color: var(--text-secondary);
      max-width: min(680px, 92vw);
      margin: 0 auto var(--space-4);
      line-height: 1.6;
      animation: fadeInUp .8s ease-out .15s both;
    }

    .search-form{ max-width: min(760px, 95vw); margin: 0 auto var(--space-5); position: relative; animation: fadeInUp .8s ease-out .3s both; }
    .search-input{
      width: 100%; background: var(--bg-card); color: var(--text-primary);
      border: 2px solid var(--border-color); border-radius: 1rem;
      padding: 1rem 1.1rem; padding-right: clamp(7.2rem, 26vw, 10.5rem);
      font-size: clamp(.95rem, 2.8vw, 1.05rem);
      transition: all .25s ease;
    }
    .search-input:focus{ outline:none; border-color: var(--primary-start); box-shadow: var(--shadow-neon); background: var(--bg-secondary); }
    .search-input::placeholder{ color: var(--text-muted); }
    .search-button{
      position: absolute; right: .4rem; top: 50%; transform: translateY(-50%);
      background: var(--gradient-primary); color:#fff; border:none;
      padding: .7rem 1.1rem; border-radius: .75rem; font-weight: 700; cursor: pointer;
      transition: all .25s ease; font-size: clamp(.9rem, 2.5vw, 1rem);
    }
    .search-button:hover{ box-shadow: var(--shadow-intense); transform: translateY(-50%) scale(1.04); }
    .search-button:disabled{ opacity:.6; cursor:not-allowed; transform: translateY(-50%); }

    /* ---------- Sections ---------- */
    .section-title{
      font-family:'Space Grotesk',sans-serif;
      font-size: clamp(1.25rem, 4.5vw, 2rem);
      font-weight: 800; margin-bottom: .8rem; text-align:center;
      background: linear-gradient(45deg, var(--accent-cyan), var(--accent-blue));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
    }

    .trending-section{ margin-bottom: var(--space-5); animation: fadeInUp .8s ease-out .4s both; }

    .trending-grid{
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(clamp(120px, 32vw, 170px), 1fr));
      gap: clamp(.6rem, 2vw, 1rem);
    }
    .trending-card{
      background: var(--bg-card); border-radius: .8rem; overflow:hidden; border: 1px solid var(--border-color);
      transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
      cursor: pointer; position: relative; isolation: isolate;
    }
    .trending-card::before{ content:''; position:absolute; inset:0; background: var(--gradient-primary); opacity:0; transition: opacity .25s ease; z-index:1; pointer-events:none; }
    .trending-card:hover{ transform: translateY(-4px) scale(1.015); box-shadow: var(--shadow-card); border-color: var(--primary-start); }
    .trending-card:hover::before{ opacity: .08; }
    .trending-poster{ width:100%; aspect-ratio: 2/3; object-fit: cover; display:block; }
    .trending-info{ padding: .6rem .7rem; }
    .trending-title{ font-weight: 600; font-size: .95rem; line-height: 1.3; display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical; overflow:hidden; margin:0 0 .25rem; }
    .trending-rating{ color: var(--accent-green); font-size: .85rem; font-weight: 600; }

    .mood-suggestions{ margin-bottom: var(--space-5); animation: fadeInUp .8s ease-out .5s both; }
    .suggestions-title{ display:flex; align-items:center; justify-content:center; gap:.6rem; color: var(--text-secondary); margin-bottom: 1rem; font-weight:600; font-size: clamp(.9rem, 2.8vw, 1rem); }
    .suggestions-grid{ display:flex; flex-wrap:wrap; gap: .6rem .6rem; justify-content:center; max-width: 980px; margin: 0 auto; padding-inline: .2rem; }
    .suggestion-button{
      position: relative; overflow:hidden; cursor:pointer;
      padding: .65rem .95rem; border-radius: 2rem; font-size: clamp(.85rem, 2.7vw, .95rem);
      background: var(--bg-card); color: var(--text-secondary);
      border: 1px solid var(--border-color); transition: all .25s ease;
      touch-action: manipulation;
    }
    .suggestion-button:hover{ color:#fff; border-color: var(--primary-start); transform: translateY(-2px); }
    .suggestion-button::before{ content:''; position:absolute; inset:0; background: var(--gradient-primary); opacity:0; transition: opacity .25s ease; border-radius: inherit; }
    .suggestion-button:hover::before{ opacity: 1; }
    .suggestion-button span{ position: relative; z-index: 1; }

    .history-section{ margin-bottom: var(--space-5); display:none; }
    .history-section.show{ display:block; animation: fadeInUp .6s ease-out both; }
    .history-grid{ display:grid; gap: .6rem; max-width: min(820px, 95vw); margin: 0 auto; }
    .history-item{
      display:flex; align-items:center; justify-content:space-between; gap: .8rem;
      padding: .8rem .9rem; border:1px solid var(--border-color); border-radius: .75rem; background: var(--bg-card);
      cursor:pointer; transition: all .25s ease;
    }
    .history-item:hover{ border-color: var(--accent-cyan); background: var(--bg-secondary); }
    .history-mood{ font-weight: 600; color: var(--text-primary); font-size: clamp(.95rem, 2.8vw, 1rem); }
    .history-date{ color: var(--text-muted); font-size: .85rem; }

    .movies-section{ display:none; }
    .movies-section.show{ display:block; }
    .movies-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(clamp(150px, 42vw, 220px), 1fr));
      gap: clamp(.8rem, 2.5vw, 1.5rem);
      padding: var(--space-4) 0;
    }
    .movie-card{
      background: var(--bg-card); border:1px solid var(--border-color); border-radius: 1rem;
      overflow:hidden; cursor: pointer; position: relative; transition: transform .25s ease, border-color .25s ease, box-shadow .25s ease;
      animation: fadeInUp .6s ease-out both;
    }
    .movie-card:hover{ transform: translateY(-6px) scale(1.02); border-color: var(--primary-start); box-shadow: var(--shadow-card); }
    .movie-card::before{ content:''; position:absolute; inset:0; background: var(--gradient-primary); opacity:0; transition: opacity .25s ease; z-index:1; pointer-events:none; }
    .movie-card:hover::before{ opacity: .08; }
    .movie-poster{ width:100%; aspect-ratio: 2/3; object-fit: cover; display:block; position: relative; z-index:2; }
    .movie-info{ padding: .85rem .9rem; position: relative; z-index: 2; }
    .movie-title{ font-weight: 700; margin: 0 0 .35rem; line-height: 1.35; font-size: clamp(.95rem, 2.8vw, 1.05rem); }
    .movie-rating{ color: var(--accent-green); font-size: .85rem; font-weight: 600; }

    /* Auth Modal Styles */
    .auth-modal{
      position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center; z-index: 1000;
    }
    .auth-modal.hidden{ display: none; }
    .auth-modal-content{
      background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 1.5rem;
      padding: 2rem; max-width: 420px; width: 90%; box-shadow: var(--shadow-card);
      animation: slideUp .3s ease-out;
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .auth-title{ font-family: 'Space Grotesk', sans-serif; font-size: 1.8rem; font-weight: 800; margin-bottom: 0.5rem; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .auth-subtitle{ color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.95rem; }
    .auth-form{ display: flex; flex-direction: column; gap: 1rem; }
    .auth-input{
      background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.75rem;
      padding: 0.85rem 1rem; color: var(--text-primary); font-size: 0.95rem;
      transition: all .25s ease;
    }
    .auth-input:focus{ outline: none; border-color: var(--primary-start); box-shadow: var(--shadow-neon); }
    .auth-input::placeholder{ color: var(--text-muted); }
    .auth-button{
      background: var(--gradient-primary); color: #fff; border: none; border-radius: 0.75rem;
      padding: 0.9rem 1.2rem; font-weight: 700; font-size: 1rem; cursor: pointer;
      transition: all .25s ease;
    }
    .auth-button:hover{ box-shadow: var(--shadow-intense); transform: translateY(-2px); }
    .auth-button:disabled{ opacity: 0.6; cursor: not-allowed; }
    .auth-toggle{ text-align: center; color: var(--text-secondary); font-size: 0.9rem; margin-top: 1rem; }
    .auth-toggle button{ background: none; border: none; color: var(--accent-cyan); cursor: pointer; font-weight: 600; }
    .auth-toggle button:hover{ text-decoration: underline; }
    .auth-error{ color: #ff6b6b; font-size: 0.85rem; margin-top: 0.5rem; }

    /* Footer */
    .site-footer{
      background: var(--bg-glass); border-top: 1px solid var(--border-color);
      padding: var(--space-4); text-align: center; color: var(--text-secondary);
      margin-top: var(--space-5);
    }
    .site-footer__inner{ max-width: 1200px; margin: 0 auto; }
    .site-footer__brand{ font-weight: 600; margin-bottom: 0.5rem; }
    .site-footer__links{ display: flex; justify-content: center; gap: 0.5rem; font-size: 0.9rem; }
    .site-footer__links a{ color: var(--accent-cyan); text-decoration: none; transition: opacity .25s ease; }
    .site-footer__links a:hover{ opacity: 0.8; }
    .dot{ color: var(--text-muted); }

    .hidden{ display: none; }
    .spinner{ width: 38px; height: 38px; border-radius: 50%; border: 3px solid rgba(255,255,255,.15); border-top-color: var(--primary-start); animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .modal{ position: fixed; inset: 0; background: rgba(0,0,0,.5); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 100; }
    .modal.show{ display: flex; }
    .modal-content{ max-width: min(900px, 92vw); max-height: 90vh; overflow: auto; border-radius: 16px; background: var(--bg-card); border: 1px solid var(--border-color); box-shadow: var(--shadow-card); animation: pop .18s ease; }
    @keyframes pop { from { opacity: 0; transform: scale(.97); } to { opacity: 1; transform: scale(1); } }
    .modal-close{ position: absolute; right: 14px; top: 10px; border: 0; background: transparent; color: var(--text-secondary); font-size: 24px; cursor: pointer; }
    .modal-close:hover{ color: var(--text-primary); }

    .room-modal-content{ width: min(560px, 92vw); border-radius: 16px; background: var(--bg-card); border: 1px solid var(--border-color); box-shadow: var(--shadow-card); padding: 20px; animation: pop .18s ease; position: relative; }
    .room-title{ font-family: 'Space Grotesk', sans-serif; font-size: 1.5rem; font-weight: 800; margin-bottom: 1rem; }
    .room-form{ display: grid; gap: 1rem; }
    .room-field{ display: flex; flex-direction: column; gap: 0.5rem; }
    .room-label{ font-weight: 600; color: var(--text-primary); font-size: 0.9rem; }
    .room-input{ background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 0.75rem 1rem; color: var(--text-primary); font-size: 0.9rem; }
    .room-input:focus{ outline: none; border-color: var(--primary-start); }
    .room-hint{ display: block; color: var(--text-muted); font-size: 0.85rem; }
    .room-id-row{ display: flex; gap: 0.5rem; }
    .room-id-row input{ flex: 1; }
    .pill-button{ padding: 0.6rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 2rem; color: var(--text-secondary); cursor: pointer; transition: all .25s ease; }
    .pill-button:hover{ border-color: var(--accent-cyan); color: var(--accent-cyan); }
    .room-actions{ display: flex; gap: 0.75rem; }
    .primary-button{ flex: 1; padding: 0.8rem 1rem; background: var(--gradient-primary); color: #fff; border: none; border-radius: 0.75rem; font-weight: 700; cursor: pointer; transition: all .25s ease; }
    .primary-button:hover{ box-shadow: var(--shadow-intense); }
    .secondary-button{ flex: 1; padding: 0.8rem 1rem; background: transparent; color: var(--accent-cyan); border: 1px solid var(--accent-cyan); border-radius: 0.75rem; font-weight: 700; cursor: pointer; transition: all .25s ease; }
    .secondary-button:hover{ background: rgba(50, 200, 255, 0.1); }

    @media (max-width: 720px){
      .movie-poster, .trending-poster{ height: 220px; }
    }
  </style>
</head>
<body>
  <!-- Auth Modal - shown on page load if not logged in -->
  <div class="auth-modal" id="authModal">
    <div class="auth-modal-content">
      <h2 class="auth-title" id="authTitle">Sign In</h2>
      <p class="auth-subtitle">Welcome to CineVibe - Find your perfect movie vibe</p>
      <form class="auth-form" id="authForm">
        <input type="email" class="auth-input" id="authEmail" placeholder="Email" required>
        <input type="password" class="auth-input" id="authPassword" placeholder="Password" required>
        <button type="submit" class="auth-button" id="authSubmit">Sign In</button>
        <div class="auth-error" id="authError"></div>
      </form>
      <div class="auth-toggle">
        <span id="authToggleText">Don't have an account?</span>
        <button type="button" id="authToggleBtn">Sign Up</button>
      </div>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="logo" id="logoHome">
      <div class="logo-icon">🎬</div>
      <div class="logo-text">CineVibe</div>
    </div>
    <div class="nav-actions">
      <button class="history-button" id="historyToggle">Search History</button>
      <input type="range" id="musicVolume" min="0" max="100" value="50">
      <button class="logout-button" id="logoutBtn">Logout</button>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container">
    <!-- Hero Section -->
    <section class="hero-section" id="heroSection">
      <h1 class="hero-title">Find Your Vibe</h1>
      <p class="hero-subtitle">Discover movies that match your mood. Tell us how you're feeling, and we'll find the perfect film for you.</p>
    </section>

    <!-- Search Form -->
    <form class="search-form" id="searchForm">
      <input type="text" class="search-input" id="moodInput" placeholder="What's your mood? (e.g., 'feeling adventurous', 'need a laugh')" required>
      <button type="submit" class="search-button" id="searchButton">Search</button>
    </form>

    <!-- Mood Suggestions -->
    <div class="mood-suggestions" id="moodSuggestions">
      <div class="suggestions-title">
        <span>✨ Try a mood:</span>
      </div>
      <div class="suggestions-grid" id="suggestionsGrid"></div>
    </div>

    <!-- Trending Section -->
    <section class="trending-section" id="trendingSection">
      <h2 class="section-title">Trending Now</h2>
      <div class="trending-grid" id="trendingGrid"></div>
    </section>

    <!-- History Section -->
    <section class="history-section" id="historySection">
      <h2 class="section-title">Your Search History</h2>
      <div class="history-grid" id="historyGrid"></div>
    </section>

    <!-- Movies Section -->
    <section class="movies-section" id="moviesSection">
      <h2 class="section-title" id="moviesTitle">Movies for Your Mood</h2>
      <div class="movies-grid" id="moviesGrid"></div>
    </section>
  </div>

  <!-- Movie Modal -->
  <div class="modal" id="movieModal">
    <div class="modal-content" id="movieModalContent">
      <button class="modal-close" id="modalClose">&times;</button>
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="site-footer__inner">
      <div class="site-footer__brand">© 2025 CineVibe</div>
      <nav class="site-footer__links">
        <a href="https://www.instagram.com/jayesh_cringzz/" target="_blank" rel="noopener">Instagram</a>
        <span class="dot">•</span>
        <a href="https://github.com/jayesh25-trade" target="_blank" rel="noopener">GitHub</a>
      </nav>
    </div>
  </footer>

  <!-- Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Main App Script -->
  <script>
    'use strict';

    const SUPABASE_URL = 'https://ipaduwfqyapuqhvvicqm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwYWR1d2ZxeWFwdXFodnZpY3FtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNzk4NTEsImV4cCI6MjA3Njk1NTg1MX0.Gr8n1k-q3IT8IYvIrM4lH8CVGQOsRKkvSXM01TF5ibk';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Utilities
    const $ = (id) => document.getElementById(id);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const toast = (msg) => {
      const el = document.createElement('div');
      Object.assign(el.style, {
        position: 'fixed', left: '50%', transform: 'translateX(-50%)', bottom: '24px',
        background: 'rgba(0,0,0,0.8)', color: '#fff', padding: '10px 14px',
        borderRadius: '12px', fontFamily: 'system-ui,sans-serif', fontSize: '14px',
        zIndex: 99999, opacity: '0', transition: 'opacity 200ms ease'
      });
      el.textContent = msg;
      document.body.appendChild(el);
      requestAnimationFrame(() => { el.style.opacity = '1'; });
      setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 240); }, 1800);
    };

    // State
    let isLoading = false;
    let currentUser = null;
    let isSignUpMode = false;
    let currentMovies = [];

    // DOM Elements
    const authModal = $('authModal');
    const authForm = $('authForm');
    const authEmail = $('authEmail');
    const authPassword = $('authPassword');
    const authSubmit = $('authSubmit');
    const authTitle = $('authTitle');
    const authToggleBtn = $('authToggleBtn');
    const authToggleText = $('authToggleText');
    const authError = $('authError');
    const logoutBtn = $('logoutBtn');
    const searchForm = $('searchForm');
    const moodInput = $('moodInput');
    const searchButton = $('searchButton');
    const moviesGrid = $('moviesGrid');
    const moviesSection = $('moviesSection');
    const moviesTitle = $('moviesTitle');
    const movieModal = $('movieModal');
    const modalClose = $('modalClose');
    const historyToggle = $('historyToggle');
    const historySection = $('historySection');
    const historyGrid = $('historyGrid');
    const trendingSection = $('trendingSection');
    const trendingGrid = $('trendingGrid');
    const moodSuggestions = $('moodSuggestions');
    const suggestionsGrid = $('suggestionsGrid');
    const logoHome = $('logoHome');
    const heroSection = $('heroSection');

    const API_BASE_URL = 'https://cinevibe-movie.onrender.com/api';

    async function initAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user) {
        currentUser = session.user;
        showApp();
      } else {
        showAuthModal();
      }

      supabase.auth.onAuthStateChange((event, session) => {
        if (session?.user) {
          currentUser = session.user;
          showApp();
        } else {
          currentUser = null;
          showAuthModal();
        }
      });
    }

    function showAuthModal() {
      authModal.classList.remove('hidden');
      searchForm.style.display = 'none';
      moodSuggestions.style.display = 'none';
      trendingSection.style.display = 'none';
      historySection.style.display = 'none';
      moviesSection.classList.remove('show');
    }

    function showApp() {
      authModal.classList.add('hidden');
      searchForm.style.display = 'block';
      moodSuggestions.style.display = 'block';
      trendingSection.style.display = 'block';
      loadTrendingMovies();
      loadSearchHistory();
    }

    async function handleAuthSubmit(e) {
      e.preventDefault();
      authError.textContent = '';
      authSubmit.disabled = true;
      authSubmit.textContent = 'Loading...';

      const email = authEmail.value.trim();
      const password = authPassword.value.trim();

      if (!email || !password) {
        authError.textContent = 'Please fill in all fields';
        authSubmit.disabled = false;
        authSubmit.textContent = isSignUpMode ? 'Sign Up' : 'Sign In';
        return;
      }

      try {
        if (isSignUpMode) {
          const { error } = await supabase.auth.signUp({
            email,
            password,
            options: { emailRedirectTo: window.location.origin }
          });
          if (error) throw error;
          toast('Account created! Check your email to confirm.');
          authEmail.value = '';
          authPassword.value = '';
        } else {
          const { error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;
          toast('Welcome back! 🎬');
        }
      } catch (error) {
        authError.textContent = error.message || 'Authentication failed';
      } finally {
        authSubmit.disabled = false;
        authSubmit.textContent = isSignUpMode ? 'Sign Up' : 'Sign In';
      }
    }

    function toggleAuthMode() {
      isSignUpMode = !isSignUpMode;
      authTitle.textContent = isSignUpMode ? 'Sign Up' : 'Sign In';
      authSubmit.textContent = isSignUpMode ? 'Sign Up' : 'Sign In';
      authToggleText.textContent = isSignUpMode ? 'Already have an account?' : "Don't have an account?";
      authToggleBtn.textContent = isSignUpMode ? 'Sign In' : 'Sign Up';
      authError.textContent = '';
    }

    async function handleLogout() {
      await supabase.auth.signOut();
      toast('Signed out successfully');
      authEmail.value = '';
      authPassword.value = '';
      authError.textContent = '';
      isSignUpMode = false;
    }

    // Movie Functions
    async function fetchJSON(url, options = {}) {
      try {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error(`Request failed (${res.status})`);
        return await res.json();
      } catch (error) {
        console.error('Fetch error:', error);
        return null;
      }
    }

    async function searchMovies(mood) {
      if (isLoading) return;
      isLoading = true;
      searchButton.disabled = true;
      searchButton.textContent = 'Searching...';

      try {
        const data = await fetchJSON(`${API_BASE_URL}/recommend`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mood })
        });

        if (data?.movies) {
          currentMovies = data.movies;
          displayMovies(currentMovies);
          saveSearchHistory(mood);
          moviesSection.classList.add('show');
          moviesTitle.textContent = `Movies for "${mood}"`;
        } else {
          toast('No movies found. Try a different mood!');
        }
      } catch (error) {
        toast('Error searching movies');
        console.error(error);
      } finally {
        isLoading = false;
        searchButton.disabled = false;
        searchButton.textContent = 'Search';
      }
    }

    function displayMovies(movies) {
      moviesGrid.innerHTML = '';
      movies.forEach(movie => {
        const card = document.createElement('div');
        card.className = 'movie-card';
        card.innerHTML = `
          <img src="${movie.poster || '/placeholder.svg'}" alt="${movie.title}" class="movie-poster">
          <div class="movie-info">
            <h3 class="movie-title">${movie.title}</h3>
            <p class="movie-rating">⭐ ${movie.rating?.toFixed(1) || 'N/A'}</p>
          </div>
        `;
        card.addEventListener('click', () => showMovieModal(movie));
        moviesGrid.appendChild(card);
      });
    }

    function showMovieModal(movie) {
      const content = $('movieModalContent');
      content.innerHTML = `
        <button class="modal-close" id="modalClose">&times;</button>
        <div style="padding: 20px;">
          <img src="${movie.poster || '/placeholder.svg'}" alt="${movie.title}" style="width: 100%; max-width: 300px; border-radius: 12px; margin-bottom: 20px;">
          <h2 style="margin: 0 0 10px; font-family: 'Space Grotesk', sans-serif;">${movie.title}</h2>
          <p style="color: var(--text-secondary); margin: 0 0 15px;">${movie.releaseDate ? new Date(movie.releaseDate).getFullYear() : 'N/A'}</p>
          <p style="color: var(--accent-green); font-weight: 600; margin: 0 0 15px;">⭐ ${movie.rating?.toFixed(1) || 'N/A'}/10</p>
          <p style="color: var(--text-secondary); line-height: 1.6; margin: 0 0 20px;">${movie.overview || 'No description available'}</p>
          ${movie.trailerUrl ? `<a href="${movie.trailerUrl}" target="_blank" style="color: var(--accent-cyan); text-decoration: none; font-weight: 600;">Watch Trailer →</a>` : ''}
        </div>
      `;
      movieModal.classList.add('show');
      const newClose = $('modalClose');
      if (newClose) newClose.addEventListener('click', () => movieModal.classList.remove('show'));
    }

    async function loadTrendingMovies() {
      try {
        const data = await fetchJSON(`${API_BASE_URL}/trending`);
        if (data?.movies) {
          trendingGrid.innerHTML = '';
          data.movies.slice(0, 8).forEach(movie => {
            const card = document.createElement('div');
            card.className = 'trending-card';
            card.innerHTML = `
              <img src="${movie.poster || '/placeholder.svg'}" alt="${movie.title}" class="trending-poster">
              <div class="trending-info">
                <h3 class="trending-title">${movie.title}</h3>
                <p class="trending-rating">⭐ ${movie.rating?.toFixed(1) || 'N/A'}</p>
              </div>
            `;
            card.addEventListener('click', () => showMovieModal(movie));
            trendingGrid.appendChild(card);
          });
        }
      } catch (error) {
        console.error('Error loading trending:', error);
      }
    }

    function saveSearchHistory(mood) {
      const history = JSON.parse(localStorage.getItem('cinevibe_history') || '[]');
      history.unshift({ mood, date: new Date().toISOString() });
      localStorage.setItem('cinevibe_history', JSON.stringify(history.slice(0, 20)));
    }

    function loadSearchHistory() {
      const history = JSON.parse(localStorage.getItem('cinevibe_history') || '[]');
      if (history.length === 0) {
        historyGrid.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No search history yet</p>';
        return;
      }
      historyGrid.innerHTML = '';
      history.forEach(item => {
        const el = document.createElement('div');
        el.className = 'history-item';
        const date = new Date(item.date).toLocaleDateString();
        el.innerHTML = `<span class="history-mood">${item.mood}</span><span class="history-date">${date}</span>`;
        el.addEventListener('click', () => {
          moodInput.value = item.mood;
          searchMovies(item.mood);
        });
        historyGrid.appendChild(el);
      });
    }

    // Mood Suggestions
    const moods = ['Adventurous', 'Romantic', 'Thrilling', 'Funny', 'Mysterious', 'Inspiring', 'Relaxing', 'Intense'];
    function loadMoodSuggestions() {
      suggestionsGrid.innerHTML = '';
      moods.forEach(mood => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'suggestion-button';
        btn.innerHTML = `<span>${mood}</span>`;
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          moodInput.value = mood;
          searchMovies(mood);
        });
        suggestionsGrid.appendChild(btn);
      });
    }

    // Event Listeners
    authForm.addEventListener('submit', handleAuthSubmit);
    authToggleBtn.addEventListener('click', toggleAuthMode);
    logoutBtn.addEventListener('click', handleLogout);
    searchForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const mood = moodInput.value.trim();
      if (mood) searchMovies(mood);
    });
    modalClose.addEventListener('click', () => movieModal.classList.remove('show'));
    movieModal.addEventListener('click', (e) => {
      if (e.target === movieModal) movieModal.classList.remove('show');
    });
    historyToggle.addEventListener('click', () => {
      historySection.classList.toggle('show');
      if (historySection.classList.contains('show')) loadSearchHistory();
    });
    logoHome.addEventListener('click', () => window.location.reload());

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadMoodSuggestions();
      initAuth();
    });

    console.log('🎬 CineVibe loaded! Ready to find your perfect vibe.');
  </script>
</body>
</html>
