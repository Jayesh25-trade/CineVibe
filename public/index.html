<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <link rel="icon" type="image/png" href="/favicon.png">
  <title>CineVibe - Movie Mood Curator</title>

  <!-- Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* ---------- Reset / Base ---------- */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: 'Inter', sans-serif; color: var(--text-primary); background: var(--gradient-bg); background-attachment: fixed; overflow-x: hidden; }

    :root{
      --bg-primary: hsl(240, 15%, 6%);
      --bg-secondary: hsl(240, 12%, 9%);
      --bg-card: hsl(240, 10%, 12%);
      --bg-glass: rgba(20, 20, 30, 0.8);

      --text-primary: hsl(0, 0%, 95%);
      --text-secondary: hsl(240, 5%, 70%);
      --text-muted: hsl(240, 5%, 50%);

      --primary-start: hsl(280, 100%, 60%);
      --primary-end: hsl(320, 100%, 70%);
      --primary-glow: hsl(300, 100%, 80%);

      --accent-cyan: hsl(180, 100%, 60%);
      --accent-blue: hsl(220, 100%, 65%);
      --accent-green: hsl(120, 100%, 60%);

      --border-color: hsl(240, 10%, 20%);
      --border-glow: hsl(240, 10%, 30%);

      --gradient-primary: linear-gradient(135deg, var(--primary-start), var(--primary-end));
      --gradient-glow: linear-gradient(135deg, var(--primary-start), var(--primary-end), var(--accent-cyan));
      --gradient-bg: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-card) 100%);

      --shadow-neon: 0 0 30px rgba(200, 50, 255, 0.3);
      --shadow-card: 0 10px 40px rgba(0, 0, 0, 0.4);
      --shadow-intense: 0 0 50px rgba(200, 50, 255, 0.5);

      --space-1: clamp(0.25rem, 1vw, 0.5rem);
      --space-2: clamp(0.5rem, 1.2vw, 0.75rem);
      --space-3: clamp(0.75rem, 1.6vw, 1rem);
      --space-4: clamp(1rem, 2vw, 1.25rem);
      --space-5: clamp(1.25rem, 3vw, 2rem);
      --radius: 0.75rem;
      --radius-lg: 1rem;
    }

    /* animated soft ambient background */
    body::before {
      content: '';
      position: fixed; inset: 0;
      background:
        radial-gradient(circle at 20% 80%, rgba(200, 50, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(50, 200, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 50, 150, 0.05) 0%, transparent 50%);
      pointer-events: none; z-index: -1;
      animation: backgroundFloat 20s ease-in-out infinite;
    }
    @keyframes backgroundFloat { 0%,100%{ transform: translateY(0) } 33%{ transform: translateY(-12px) } 66%{ transform: translateY(8px) } }

    /* ---------- Navbar ---------- */
    .navbar{
      position: sticky; top: 0; z-index: 50;
      background: var(--bg-glass); backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-color);
      padding: var(--space-2) var(--space-4);
      display: flex; align-items: center; justify-content: space-between;
      gap: var(--space-2);
    }
    .logo{ display:flex; align-items:center; gap: .75rem; cursor:pointer; user-select:none; }
    .logo-icon{
      width: 2.25rem; height: 2.25rem; border-radius: .7rem;
      background: var(--gradient-primary); color:#fff; font-weight:800;
      display:flex; align-items:center; justify-content:center;
      box-shadow: var(--shadow-neon); animation: logoPulse 3s ease-in-out infinite;
    }
    @keyframes logoPulse { 0%,100%{ box-shadow: var(--shadow-neon)} 50%{ box-shadow: var(--shadow-intense)} }
    .logo-text{
      font-family: 'Space Grotesk', sans-serif;
      font-size: clamp(1.1rem, 2.8vw, 1.5rem);
      font-weight: 800;
      background: var(--gradient-primary);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip:text;
      transition: transform .2s ease, opacity .2s ease;
    }
    .logo:hover .logo-text{ opacity:.9; transform: scale(1.02); }

    .nav-actions{
      display:flex; align-items:center; gap: .5rem; flex-wrap: wrap;
      justify-content: flex-end; max-width: 100%;
    }
    .history-button{
      padding: .55rem .8rem; font-size: .9rem;
      background: transparent; border: 1px solid var(--border-color);
      border-radius: .6rem; color: var(--text-secondary);
      cursor: pointer; transition: all .25s ease; white-space: nowrap;
    }
    .history-button:hover{ border-color: var(--accent-cyan); color: var(--accent-cyan); box-shadow: 0 0 18px rgba(50,200,255,.25); }
    #musicVolume{
      width: clamp(90px, 22vw, 140px); accent-color: hsl(280 100% 65%);
    }

    .auth-button{
      padding: .45rem .75rem; font-size:.9rem; border-radius:.6rem; cursor:pointer;
      border:1px solid var(--border-color); background: transparent; color:var(--text-secondary);
    }
    .auth-button:hover{ border-color:var(--primary-start); color:#fff; background: linear-gradient(90deg,var(--primary-start),var(--primary-end)); }

    /* stack actions on very small screens */
    @media (max-width: 480px){
      .nav-actions{ gap: .4rem; }
      .history-button{ padding: .5rem .65rem; font-size: .85rem; }
    }

    /* ---------- Layout ---------- */
    .container{ max-width: 1200px; margin-inline:auto; padding: var(--space-4); }
    @media (max-width: 768px){ .container{ padding: var(--space-3); } }

    .hero-section{ text-align:center; margin-bottom: var(--space-5); }
    .hero-title{
      font-family:'Space Grotesk',sans-serif;
      font-size: clamp(2rem, 6.5vw, 4.5rem);
      font-weight: 800; margin-bottom: .6rem;
      background: var(--gradient-glow);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
      animation: fadeInUp .8s ease-out both;
      position: relative;
    }
    .hero-title::after{
      content:''; position:absolute; bottom:-10px; left:50%; transform:translateX(-50%);
      width: clamp(70px, 14vw, 120px); height: 3px; border-radius:2px;
      background: var(--gradient-primary); opacity: .7;
    }
    .hero-subtitle{
      font-size: clamp(.95rem, 2.7vw, 1.15rem);
      color: var(--text-secondary);
      max-width: min(680px, 92vw);
      margin: 0 auto var(--space-4);
      line-height: 1.6;
      animation: fadeInUp .8s ease-out .15s both;
    }

    .search-form{ max-width: min(760px, 95vw); margin: 0 auto var(--space-5); position: relative; animation: fadeInUp .8s ease-out .3s both; }
    .search-input{
      width: 100%; background: var(--bg-card); color: var(--text-primary);
      border: 2px solid var(--border-color); border-radius: 1rem;
      padding: 1rem 1.1rem; padding-right: clamp(7.2rem, 26vw, 10.5rem);
      font-size: clamp(.95rem, 2.8vw, 1.05rem);
      transition: all .25s ease;
    }
    .search-input:focus{ outline:none; border-color: var(--primary-start); box-shadow: var(--shadow-neon); background: var(--bg-secondary); }
    .search-input::placeholder{ color: var(--text-muted); }
    .search-button{
      position: absolute; right: .4rem; top: 50%; transform: translateY(-50%);
      background: var(--gradient-primary); color:#fff; border:none;
      padding: .7rem 1.1rem; border-radius: .75rem; font-weight: 700; cursor: pointer;
      transition: all .25s ease; font-size: clamp(.9rem, 2.5vw, 1rem);
    }
    .search-button:hover{ box-shadow: var(--shadow-intense); transform: translateY(-50%) scale(1.04); }
    .search-button:disabled{ opacity:.6; cursor:not-allowed; transform: translateY(-50%); }

    /* ---------- Sections ---------- */
    .section-title{
      font-family:'Space Grotesk',sans-serif;
      font-size: clamp(1.25rem, 4.5vw, 2rem);
      font-weight: 800; margin-bottom: .8rem; text-align:center;
      background: linear-gradient(45deg, var(--accent-cyan), var(--accent-blue));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
    }

    .trending-section{ margin-bottom: var(--space-5); animation: fadeInUp .8s ease-out .4s both; }

    .trending-grid{
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(clamp(120px, 32vw, 170px), 1fr));
      gap: clamp(.6rem, 2vw, 1rem);
    }
    .trending-card{
      background: var(--bg-card); border-radius: .8rem; overflow:hidden; border: 1px solid var(--border-color);
      transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
      cursor: pointer; position: relative; isolation: isolate;
    }
    .trending-card::before{ content:''; position:absolute; inset:0; background: var(--gradient-primary); opacity:0; transition: opacity .25s ease; z-index:1; pointer-events:none; }
    .trending-card:hover{ transform: translateY(-4px) scale(1.015); box-shadow: var(--shadow-card); border-color: var(--primary-start); }
    .trending-card:hover::before{ opacity: .08; }
    .trending-poster{ width:100%; aspect-ratio: 2/3; object-fit: cover; display:block; }
    .trending-info{ padding: .6rem .7rem; }
    .trending-title{ font-weight: 600; font-size: .95rem; line-height: 1.3; display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical; overflow:hidden; margin:0 0 .25rem; }
    .trending-rating{ color: var(--accent-green); font-size: .85rem; font-weight: 600; }

    /* Mood suggestions */
    .mood-suggestions{ margin-bottom: var(--space-5); animation: fadeInUp .8s ease-out .5s both; }
    .suggestions-title{ display:flex; align-items:center; justify-content:center; gap:.6rem; color: var(--text-secondary); margin-bottom: 1rem; font-weight:600; font-size: clamp(.9rem, 2.8vw, 1rem); }
    .suggestions-grid{ display:flex; flex-wrap:wrap; gap: .6rem .6rem; justify-content:center; max-width: 980px; margin: 0 auto; padding-inline: .2rem; }
    .suggestion-button{
      position: relative; overflow:hidden; cursor:pointer;
      padding: .65rem .95rem; border-radius: 2rem; font-size: clamp(.85rem, 2.7vw, .95rem);
      background: var(--bg-card); color: var(--text-secondary);
      border: 1px solid var(--border-color); transition: all .25s ease;
      touch-action: manipulation;
    }
    .suggestion-button:hover{ color:#fff; border-color: var(--primary-start); transform: translateY(-2px); }
    .suggestion-button::before{ content:''; position:absolute; inset:0; background: var(--gradient-primary); opacity:0; transition: opacity .25s ease; border-radius: inherit; }
    .suggestion-button:hover::before{ opacity: 1; }
    .suggestion-button span{ position: relative; z-index: 1; }

    /* History */
    .history-section{ margin-bottom: var(--space-5); display:none; }
    .history-section.show{ display:block; animation: fadeInUp .6s ease-out both; }
    .history-grid{ display:grid; gap: .6rem; max-width: min(820px, 95vw); margin: 0 auto; }
    .history-item{
      display:flex; align-items:center; justify-content:space-between; gap: .8rem;
      padding: .8rem .9rem; border:1px solid var(--border-color); border-radius: .75rem; background: var(--bg-card);
      cursor:pointer; transition: all .25s ease;
    }
    .history-item:hover{ border-color: var(--accent-cyan); background: var(--bg-secondary); }
    .history-mood{ font-weight: 600; color: var(--text-primary); font-size: clamp(.95rem, 2.8vw, 1rem); }
    .history-date{ color: var(--text-muted); font-size: .85rem; }

    /* Movies grid */
    .movies-section{ display:none; }
    .movies-section.show{ display:block; }
    .movies-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(clamp(150px, 42vw, 220px), 1fr));
      gap: clamp(.8rem, 2.5vw, 1.5rem);
      padding: var(--space-4) 0;
    }
    .movie-card{
      background: var(--bg-card); border:1px solid var(--border-color); border-radius: 1rem;
      overflow:hidden; cursor: pointer; position: relative; transition: transform .25s ease, border-color .25s ease, box-shadow .25s ease;
      animation: fadeInUp .6s ease-out both;
    }
    .movie-card:hover{ transform: translateY(-6px) scale(1.02); border-color: var(--primary-start); box-shadow: var(--shadow-card); }
    .movie-card::before{ content:''; position:absolute; inset:0; background: var(--gradient-primary); opacity:0; transition: opacity .25s ease; z-index:1; pointer-events:none; }
    .movie-card:hover::before{ opacity: .08; }
    .movie-poster{ width:100%; aspect-ratio: 2/3; object-fit: cover; display:block; position: relative; z-index:2; }
    .movie-info{ padding: .85rem .9rem; position: relative; z-index: 2; }
    .movie-title{ font-weight: 700; margin: 0 0 .35rem; line-height: 1.35; font-size: clamp(.95rem, 2.8vw, 1.05rem); }
    .movie-year{ color: var(--text-secondary); font-size: .9rem; margin: 0 0 .6rem; }
    .movie-platforms{ display:flex; gap:.4rem; flex-wrap:wrap; }
    .platform-badge{ padding: .25rem .5rem; background: var(--gradient-primary); color:#fff; font-size: .7rem; border-radius:.5rem; font-weight:700; }

    /* Loading screen */
    .loading-screen{
      position: fixed; inset: 0; display:none; align-items:center; justify-content:center;
      background: color-mix(in oklab, black 70%, transparent);
      backdrop-filter: blur(20px); z-index: 100;
      padding: var(--space-4);
    }
    .loading-content{ text-align:center; animation: fadeInScale .4s ease-out both; max-width: 90vw; }
    .loading-spinner{
      width: clamp(64px, 20vw, 88px); height: clamp(64px, 20vw, 88px);
      margin: 0 auto 1rem; border: 4px solid var(--border-color); border-top: 4px solid var(--primary-start);
      border-radius: 50%; animation: spin 1s linear infinite; position: relative;
    }
    .loading-spinner::after{
      content:''; position:absolute; inset: .5rem; border: 2px solid transparent; border-top: 2px solid var(--accent-cyan); border-radius:50%;
      animation: spin .8s linear infinite reverse;
    }
    .loading-text{ font-size: clamp(1.1rem, 3.8vw, 1.5rem); font-weight:800; margin: .25rem 0 .4rem;
      background: var(--gradient-primary); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
    .loading-subtitle{ color: var(--text-secondary); max-width: 520px; margin: 0 auto; font-size: clamp(.9rem, 2.7vw, 1rem); }
    .loading-dots{ display:flex; gap:.5rem; justify-content:center; margin-top: 1.2rem; }
    .loading-dot{ width:.75rem; height:.75rem; border-radius:50%; background: var(--primary-start); animation: loadingDots 1.4s ease-in-out infinite; }
    .loading-dot:nth-child(2){ animation-delay:.2s; background: var(--primary-end); }
    .loading-dot:nth-child(3){ animation-delay:.4s; background: var(--accent-cyan); }

    /* Modal (movie & room) */
    .modal{ position: fixed; inset:0; display:none; align-items:center; justify-content:center; z-index: 200; padding: var(--space-4); background: rgba(0,0,0,.88); }
    .modal-content{
      background: var(--bg-card); border:1px solid var(--border-glow);
      border-radius: 1rem; width: min(900px, 96vw); max-height: min(90vh, 100svh - 2rem);
      overflow: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none;
      animation: fadeInScale .28s ease-out both; position: relative;
    }
    .modal-content::-webkit-scrollbar{ display:none; }
    .modal-close{
      position: sticky; top: .75rem; float: right; margin: .75rem;
      width: 2.5rem; height: 2.5rem; border-radius: 50%;
      border: none; background: var(--bg-glass); color: var(--text-primary);
      font-size: 1.2rem; cursor: pointer; z-index: 10; transition: background .2s ease, color .2s ease;
    }
    .modal-close:hover{ background: var(--primary-start); color: #fff; }

    /* Create/Join room modal contents (use same backdrop) */
    .room-modal-content{
      background: var(--bg-card); border: 1px solid var(--border-glow);
      border-radius: 1rem; width: min(520px, 94vw); max-height: min(92vh, 100svh - 2rem);
      overflow:auto; -webkit-overflow-scrolling: touch; padding: 1.25rem 1.1rem 1.2rem;
      animation: fadeInScale .25s ease-out both; position: relative;
    }
    .room-form{ display:flex; flex-direction:column; gap: .85rem; }
    .room-title{ margin: .2rem 0 .2rem; font-family:'Space Grotesk',sans-serif; font-size: clamp(1.25rem, 4.5vw, 1.6rem); background: var(--gradient-primary); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
    .room-subtitle{ color: var(--text-secondary); margin-bottom: .4rem; font-size: .95rem; }
    .room-field{ display:flex; flex-direction:column; gap: .45rem; }
    .room-label{ color: var(--text-secondary); font-weight:600; font-size:.9rem; }
    .room-input{
      background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: .65rem;
      color: var(--text-primary); padding: .7rem .8rem; font-size: 1rem; width: 100%;
    }
    .room-id-row{ display:flex; gap: .5rem; flex-wrap: wrap; }
    .pill-button{
      padding: .6rem .8rem; border-radius: .6rem; border:1px solid var(--border-color);
      background: var(--bg-card); color: var(--text-secondary); font-weight:700; cursor:pointer; transition: all .2s ease;
    }
    .pill-button:hover{ border-color: var(--accent-cyan); color: var(--accent-cyan); }
    .room-actions{ display:flex; gap: .6rem; flex-wrap:wrap; }
    .primary-button, .secondary-button{
      padding: .75rem 1.05rem; border-radius: .75rem; font-weight: 800; cursor:pointer; transition: all .25s ease;
      border: 1px solid var(--border-color);
    }
    .primary-button{ background: var(--gradient-primary); color: #fff; border: none; }
    .primary-button:hover{ transform: scale(1.03); box-shadow: var(--shadow-intense); }
    .secondary-button{ background: transparent; color: var(--text-secondary); }
    .secondary-button:hover{ border-color: var(--accent-cyan); color: var(--accent-cyan); box-shadow: 0 0 18px rgba(50,200,255,.25); }

    /* Footer */
    .site-footer{ width:100%; background: linear-gradient(180deg, rgba(20,20,30,0) 0%, rgba(12,12,18,1) 30%); border-top: 1px solid var(--border-color); margin-top: var(--space-5); }
    .site-footer__inner{ max-width: 1200px; margin: 0 auto; padding: 1rem var(--space-4); display:flex; align-items:center; justify-content:space-between; gap: .75rem; }
    .site-footer__brand{ color: var(--text-primary); font-weight: 800; letter-spacing: .3px; font-size: clamp(.95rem, 3vw, 1rem); }
    .site-footer__links{ display:flex; align-items:center; gap: .9rem; color: var(--text-secondary); font-weight:700; flex-wrap:wrap; }
    .site-footer__links a{ color: var(--text-secondary); text-decoration:none; border-bottom:1px solid transparent; transition: color .2s ease, border-color .2s ease, transform .2s ease; }
    .site-footer__links a:hover{ color: var(--accent-cyan); border-color: var(--accent-cyan); transform: translateY(-1px); }
    .site-footer__links .dot{ opacity:.35; }
    @media (max-width: 768px){
      .site-footer__inner{ padding: .9rem var(--space-3); flex-direction: column; gap: .4rem; align-items:flex-start; }
    }

    /* Auth modal */
    .auth-modal { position: fixed; inset: 0; display: none; align-items:center; justify-content:center; z-index: 300; padding: 1.25rem; background: rgba(0,0,0,0.6); }
    .auth-panel { width: 420px; max-width: 96vw; background: var(--bg-card); border: 1px solid var(--border-glow); padding: 1.15rem; border-radius: 12px; box-shadow: var(--shadow-card); }
    .auth-panel h3 { margin: 0 0 .6rem; font-family:'Space Grotesk',sans-serif; font-size:1.2rem; background: var(--gradient-primary); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
    .auth-field { display:block; margin-bottom:.6rem; }
    .auth-input { width:100%; padding:.65rem .8rem; border-radius:.6rem; border:1px solid var(--border-color); background:var(--bg-secondary); color:var(--text-primary); }
    .auth-actions { display:flex; gap:.6rem; margin-top:.7rem; align-items:center; justify-content:space-between; }
    .auth-toggle { background:transparent; border:none; color:var(--text-secondary); cursor:pointer; text-decoration:underline; font-size:.9rem; }
    .auth-error { color:#ff7b7b; margin-top:.45rem; font-size:.9rem; display:none; }
    .auth-aux { font-size:.85rem; color:var(--text-secondary); margin-top:.45rem; }

    /* Animations */
    @keyframes fadeInUp{ from{ opacity:0; transform: translateY(24px) } to{ opacity:1; transform: translateY(0)} }
    @keyframes fadeInScale{ from{ opacity:0; transform: scale(.94)} to{ opacity:1; transform: scale(1)} }
    @keyframes spin{ to{ transform: rotate(360deg) } }
    @keyframes loadingDots{ 0%,20%{ transform: scale(1) } 50%{ transform: scale(1.5) } 80%,100%{ transform: scale(1) } }

    /* Small device fine-tuning */
    @media (max-width: 400px){
      .suggestions-grid{ gap: .5rem; }
      .suggestion-button{ padding: .55rem .8rem; }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="logo" id="logoHome">
      <div class="logo-icon">C</div>
      <div class="logo-text">CineVibe</div>
    </div>
    <div class="nav-actions">
      <button class="history-button" id="historyToggle">📚 History</button>
      <button class="history-button" id="shuffleBtn">🔀 Shuffle 50</button>
      <button class="history-button" id="musicToggle">🔇 Music: Off</button>
      <input id="musicVolume" type="range" min="0" max="1" step="0.01" value="0.25" />
      <button class="auth-button" id="authBtn">Sign In</button>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container">
    <div class="hero-section" id="heroSection">
      <h1 class="hero-title">What's your vibe today?</h1>
      <p class="hero-subtitle">Drop your mood and let our AI curate the perfect cinematic experience that matches your energy ✨</p>

      <form class="search-form" id="searchForm">
        <input type="text" class="search-input" id="moodInput" placeholder="e.g., something dark and twisted that messes with my mind..." required />
        <button type="submit" class="search-button" id="searchButton">Find Movies</button>
      </form>
    </div>

    <div class="trending-section" id="trendingSection">
      <!-- optional home rows get injected -->
      <!-- <div class="trending-grid" id="trendingGrid"></div> -->
    </div>

    <div class="history-section" id="historySection">
      <h2 class="section-title">📚 Your Search History</h2>
      <div class="history-grid" id="historyGrid"></div>
    </div>

    <div class="mood-suggestions" id="moodSuggestions">
      <div class="suggestions-title"><span>💫</span><span>Popular vibes to explore:</span></div>
      <div class="suggestions-grid">
        <button class="suggestion-button" data-mood="something that'll mess with my head and leave me questioning reality"><span>Mind-bending psychological thriller</span></button>
        <button class="suggestion-button" data-mood="aesthetic dark academia vibes with mystery"><span>Dark academia mystery</span></button>
        <button class="suggestion-button" data-mood="chaotic energy with unhinged characters"><span>Chaotic energy films</span></button>
        <button class="suggestion-button" data-mood="nostalgic 90s/2000s comfort movies"><span>Y2K nostalgia comfort</span></button>
        <button class="suggestion-button" data-mood="visually stunning sci-fi that blows my mind"><span>Visually stunning sci-fi</span></button>
        <button class="suggestion-button" data-mood="lesbian/sapphic romance that makes me cry happy tears"><span>Sapphic romance tearjerker</span></button>
        <button class="suggestion-button" data-mood="foreign films that are pure cinema"><span>Foreign cinema masterpieces</span></button>
        <button class="suggestion-button" data-mood="underground cult classics nobody talks about"><span>Underground cult classics</span></button>
        <button class="suggestion-button" data-mood="horror that's actually scary not just jumpscares"><span>Actually scary horror</span></button>
        <button class="suggestion-button" data-mood="feel-good movies that restore faith in humanity"><span>Faith in humanity restored</span></button>
      </div>
    </div>

    <div class="movies-section" id="moviesSection">
      <h2 class="section-title" id="moviesTitle">Your Curated Selection</h2>
      <div class="movies-grid" id="moviesGrid"></div>
    </div>
  </div>

  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <h2 class="loading-text">Curating your perfect vibe<span id="loadingDots">...</span></h2>
      <p class="loading-subtitle">Our AI is analyzing your mood and finding movies that match your exact energy</p>
      <div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>
    </div>
  </div>

  <!-- Movie Modal -->
  <div class="modal" id="movieModal">
    <div class="modal-content" id="modalContent">
      <button class="modal-close" id="modalClose" aria-label="Close">&times;</button>
      <!-- content injected -->
    </div>
  </div>

  <!-- Create Room Modal -->
  <div class="modal" id="createRoomModal">
    <div class="room-modal-content">
      <button class="modal-close" id="createRoomClose" aria-label="Close">&times;</button>
      <div class="room-form">
        <h2 class="room-title">Create a Watch Room</h2>
        <p class="room-subtitle">Invite friends and vibe together in real time</p>

        <div class="room-field">
          <label class="room-label">Display Name</label>
          <input type="text" id="crDisplayName" class="room-input" placeholder="e.g., Aisha" required>
        </div>

        <div class="room-field">
          <label class="room-label">Room Name</label>
          <input type="text" id="crRoomName" class="room-input" placeholder="e.g., Friday Scary Night" required>
        </div>

        <div class="room-field">
          <label class="room-label">Room ID</label>
          <div class="room-id-row">
            <input type="text" id="crRoomId" class="room-input" readonly>
            <button class="pill-button" id="regenRoomId">↻</button>
            <button class="pill-button" id="copyRoomId">Copy</button>
          </div>
          <small class="room-hint" style="color:var(--text-muted)">Share this code or use the Share button below</small>
        </div>

        <div class="room-actions">
          <button class="primary-button" id="crJoinBtn">Join</button>
          <button class="secondary-button" id="crShareBtn">Share</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Join Room Modal -->
  <div class="modal" id="joinRoomModal">
    <div class="room-modal-content">
      <button class="modal-close" id="joinRoomClose" aria-label="Close">&times;</button>
      <div class="room-form">
        <h2 class="room-title">Join a Room</h2>
        <div class="room-field">
          <label class="room-label">Display Name</label>
          <input type="text" id="jrDisplayName" class="room-input" placeholder="e.g., Aisha" required>
        </div>
        <div class="room-field">
          <label class="room-label">Room ID</label>
          <input type="text" id="jrRoomId" class="room-input" placeholder="Paste the code">
        </div>
        <div class="room-actions">
          <button class="primary-button" id="jrJoinBtn">Join</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="site-footer__inner">
      <div class="site-footer__brand">© 2025 Jayesh_Mal</div>
      <nav class="site-footer__links">
        <a href="https://www.instagram.com/jayesh_cringzz/" target="_blank" rel="noopener">Instagram</a>
        <span class="dot">•</span>
        <a href="https://github.com/jayesh25-trade" target="_blank" rel="noopener">GitHub</a>
      </nav>
    </div>
  </footer>

  <!-- Auth Modal -->
  <div class="auth-modal" id="authModal" aria-hidden="true">
    <div class="auth-panel" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <h3 id="authTitle">Sign in to CineVibe</h3>
      <div class="auth-field">
        <input id="authEmail" class="auth-input" type="email" placeholder="Email" autocomplete="email" />
      </div>
      <div class="auth-field">
        <input id="authPassword" class="auth-input" type="password" placeholder="Password" autocomplete="current-password" />
      </div>
      <div style="display:flex;gap:.5rem;align-items:center;">
        <button id="authSubmit" class="primary-button" style="flex:1">Sign In</button>
        <button id="authClose" class="secondary-button">Close</button>
      </div>
      <div class="auth-aux" style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-size:.88rem;color:var(--text-secondary)"><button id="authModeToggle" class="auth-toggle">Create account</button></div>
        <div style="font-size:.82rem;color:var(--text-muted)">We use Supabase Auth (email)</div>
      </div>
      <div class="auth-error" id="authError"></div>
    </div>
  </div>

  <!-- App logic -->
  <script>
    // ---------- Supabase init ----------
    // Provided supabase project details (from your message)
    const SUPABASE_URL = 'https://ipaduwfqyapuqhvvicqm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwYWR1d2ZxeWFwdXFodnZpY3FtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNzk4NTEsImV4cCI6MjA3Njk1NTg1MX0.Gr8n1k-q3IT8IYvIrM4lH8CVGQOsRKkvSXM01TF5ibk';

    // Create client
    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Auth UI helpers (will be used by the rest of the app)
    (function(){
      const authModal = document.getElementById('authModal');
      const authBtn = document.getElementById('authBtn');
      const authSubmit = document.getElementById('authSubmit');
      const authClose = document.getElementById('authClose');
      const authModeToggle = document.getElementById('authModeToggle');
      const authEmail = document.getElementById('authEmail');
      const authPassword = document.getElementById('authPassword');
      const authError = document.getElementById('authError');

      let isSignIn = true;
      let pendingMood = null; // store a pending mood to run after successful login

      function showAuthModal(pending) {
        pendingMood = pending || null;
        authError.style.display = 'none';
        authError.textContent = '';
        authEmail.value = '';
        authPassword.value = '';
        isSignIn = true;
        authSubmit.textContent = 'Sign In';
        authModeToggle.textContent = 'Create account';
        authModal.style.display = 'flex';
        authModal.setAttribute('aria-hidden','false');
        setTimeout(()=>authEmail.focus(), 100);
      }
      function closeAuthModal(){
        authModal.style.display = 'none';
        authModal.setAttribute('aria-hidden','true');
      }

      // wire up toggle
      authModeToggle.addEventListener('click', (e)=>{
        e.preventDefault();
        isSignIn = !isSignIn;
        authSubmit.textContent = isSignIn ? 'Sign In' : 'Sign Up';
        authModeToggle.textContent = isSignIn ? 'Create account' : 'Have an account? Sign in';
        authError.style.display='none';
      });

      authClose.addEventListener('click', ()=> closeAuthModal());

      // On successful auth state change, update nav and run pending action if present
      function updateAuthButton(user){
        const btn = document.getElementById('authBtn');
        if(!btn) return;
        if(user) {
          btn.textContent = user.email ? `${user.email.split('@')[0]} • Sign Out` : 'Sign Out';
          btn.title = user.email || 'Signed in';
        } else {
          btn.textContent = 'Sign In';
        }
      }

      // attach auth button action
      const topAuthBtn = document.getElementById('authBtn');
      topAuthBtn.addEventListener('click', async () => {
        const { data: { session } } = await window.supabase.auth.getSession();
        if (!session) {
          showAuthModal(null);
        } else {
          // sign out
          await window.supabase.auth.signOut();
          updateAuthButton(null);
          toast('Signed out');
        }
      });

      // Handle submit (sign in / sign up)
      authSubmit.addEventListener('click', async () => {
        const email = (authEmail.value || '').trim();
        const password = (authPassword.value || '').trim();
        if (!email || !password) {
          authError.style.display='block'; authError.textContent = 'Email and password required.';
          return;
        }
        authError.style.display='none';
        authSubmit.disabled = true;
        authSubmit.textContent = isSignIn ? 'Signing in...' : 'Creating...';
        try {
          if (isSignIn) {
            const { error } = await window.supabase.auth.signInWithPassword({ email, password });
            if (error) throw error;
            // success
            const { data: { user } } = await window.supabase.auth.getUser();
            updateAuthButton(user);
            closeAuthModal();
            toast('Signed in — enjoy the vibes 🎬');
            // if user had a pending mood, trigger a search
            if (pendingMood) {
              // set input then submit the form programmatically
              const moodInput = document.getElementById('moodInput');
              if (moodInput) moodInput.value = pendingMood;
              // call the existing submit flow:
              const searchForm = document.getElementById('searchForm');
              if (searchForm) searchForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
              pendingMood = null;
            }
          } else {
            // sign up
            const { error } = await window.supabase.auth.signUp({
              email,
              password,
              options: { emailRedirectTo: window.location.origin }
            });
            if (error) throw error;
            toast('Account created! Check your email to confirm.');
            closeAuthModal();
            // Note: after signUp user may need to confirm email before session exists.
          }
        } catch (err) {
          authError.style.display='block';
          authError.textContent = err?.message || String(err);
        } finally {
          authSubmit.disabled = false;
          authSubmit.textContent = isSignIn ? 'Sign In' : 'Sign Up';
        }
      });

      // monitor auth state
      window.supabase.auth.onAuthStateChange((event, session) => {
        const user = session?.user || null;
        updateAuthButton(user);
      });

      // initial check
      (async () => {
        try {
          const { data: { session } } = await window.supabase.auth.getSession();
          updateAuthButton(session?.user || null);
        } catch {}
      })();

      // expose for external scripts to open the modal with a pending mood
      window.CineVibeAuth = {
        showAuthModalForMood: (m) => showAuthModal(m),
      };
    })();
  </script>

  <!-- Original app script (keeps all functionality) -->
  <script>
  (() => {
    'use strict';

    // ---------- Utilities ----------
    const $  = (id)  => /** @type {HTMLElement|null} */ (document.getElementById(id));
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const noop = () => {};
    const withTry = async (fn, fallback=null) => { try { return await fn(); } catch { return fallback; } };
    const normalizeBaseUrl = (u) => (u || '').replace(/\/?$/,'');
    const toYear = (d) => { const y = new Date(d).getFullYear(); return Number.isFinite(y) && y > 1900 ? y : ''; };

    function toast(msg){ try{ const el=document.createElement('div'); el.className='cv-toast';
      Object.assign(el.style,{position:'fixed',left:'50%',transform:'translateX(-50%)',bottom:'24px',background:'rgba(0,0,0,0.8)',color:'#fff',padding:'10px 14px',borderRadius:'12px',fontFamily:'system-ui,sans-serif',fontSize:'14px',zIndex:99999,opacity:'0',transition:'opacity 200ms ease'}); el.textContent=msg;
      document.body.appendChild(el); requestAnimationFrame(()=>{ el.style.opacity='1'; }); setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),240); },1800);
    }catch{ alert(msg); } }

    async function fetchJSON(url, options={}, {timeoutMs=15000}={}){
      const ctrl=new AbortController(); const id=setTimeout(()=>ctrl.abort(),timeoutMs);
      try{
        const res=await fetch(url,{...options,signal:ctrl.signal});
        const text=await res.text(); let json={};
        try{ json=text?JSON.parse(text):{}; }catch{ json={raw:text}; }
        if(!res.ok) throw new Error(json?.error || `Request failed (${res.status})`);
        return json;
      } finally { clearTimeout(id); }
    }

    // ---------- State / DOM ----------
    let isLoading=false, currentMovies=[], showingHistory=false;

    const searchForm       = $('searchForm');
    const moodInput        = /** @type {HTMLInputElement|null} */ ($('moodInput'));
    const searchButton     = /** @type {HTMLButtonElement|null} */ ($('searchButton'));
    const loadingScreen    = $('loadingScreen');
    const moviesGrid       = $('moviesGrid');
    const moviesSection    = $('moviesSection');
    const moviesTitle      = $('moviesTitle');
    const movieModal       = $('movieModal');
    const modalCloseBtn    = $('modalClose');
    const suggestionButtons= $$('.suggestion-button');
    const historyToggle    = $('historyToggle');
    const historySection   = $('historySection');
    const historyGrid      = $('historyGrid');
    const trendingSection  = $('trendingSection');
    const trendingGrid     = $('trendingGrid');
    const moodSuggestions  = $('moodSuggestions');
    const logoHome         = $('logoHome');
    const heroSection      = $('heroSection');
    const shuffleBtn       = $('shuffleBtn'); // << NEW

    // Rooms UI (optional)
    const createRoomModal  = $('createRoomModal');
    const joinRoomModal    = $('joinRoomModal');
    const createRoomClose  = $('createRoomClose');
    const joinRoomClose    = $('joinRoomClose');
    const crDisplayName    = /** @type {HTMLInputElement|null} */ ($('crDisplayName'));
    const crRoomName       = /** @type {HTMLInputElement|null} */ ($('crRoomName'));
    const crRoomId         = /** @type {HTMLInputElement|null} */ ($('crRoomId'));
    const regenRoomId      = $('regenRoomId');
    const copyRoomIdBtn    = $('copyRoomId');
    const crJoinBtn        = $('crJoinBtn');
    const crShareBtn       = $('crShareBtn');
    const jrDisplayName    = /** @type {HTMLInputElement|null} */ ($('jrDisplayName'));
    const jrRoomId         = /** @type {HTMLInputElement|null} */ ($('jrRoomId'));
    const jrJoinBtn        = $('jrJoinBtn');

    // Music UI (optional)
    const musicToggleBtn   = $('musicToggle');
    const musicVolume      = /** @type {HTMLInputElement|null} */ ($('musicVolume'));

    // API base
    const API_BASE_URL = normalizeBaseUrl(
      location.hostname.includes('localhost') ? 'http://localhost:5000/api'
                                              : 'https://cinevibe-movie.onrender.com/api'
    );

    // ---------- Home rows helpers ----------
    const HOME_ROW_IDS = [
      'rowTrendingUS','rowTrendingIN',
      'rowNowUS','rowNowIN',
      'rowUpcomingUS','rowUpcomingIN',
      'rowTrendingAnime','rowUpcomingAnime'
    ];

    function hideHomeSections() {
      if (heroSection)       heroSection.style.display = 'none';
      if (trendingSection)   trendingSection.style.display = 'none';
      if (historySection)    historySection.style.display = 'none';
      if (moodSuggestions)   moodSuggestions.style.display = 'none';
      HOME_ROW_IDS.forEach(id => { const sec = $(id); if (sec) sec.style.display = 'none'; });
    }

    function showHomeSections() {
      if (heroSection)       heroSection.style.display = 'block';
      if (trendingSection)   trendingSection.style.display = 'block';
      if (historySection)    historySection.style.display = 'block';
      if (moodSuggestions)   moodSuggestions.style.display = 'block';
      HOME_ROW_IDS.forEach(id => { const sec = $(id); if (sec) sec.style.display = 'block'; });
      if (moviesSection)     moviesSection.classList.remove('show');
    }

    // ---------- Rooms ----------
    function randomRoomId(){ const c=()=>Math.random().toString(36).slice(2,6).toUpperCase(); return `${c()}-${c()}-${c()}-${c()}`; }
    function roomLink(roomId){ const url=new URL(location.href); if(roomId) url.searchParams.set('roomId',roomId); return url.toString(); }
    async function saveRoomToFirebase(room){ return withTry(async()=>{ if (window.firebase?.db){ const ref=window.firebase.collection(window.firebase.db,'rooms'); await window.firebase.addDoc(ref,room); return true; } return false; },false); }
    function saveRoomLocal(room){ const key='cinevibe_rooms'; const rooms=JSON.parse(localStorage.getItem(key)||'[]'); const i=rooms.findIndex(r=>r.roomId===room.roomId); if(i>=0) rooms[i]=room; else rooms.push(room); localStorage.setItem(key,JSON.stringify(rooms)); }
    function getRoomLocal(roomId){ const rooms=JSON.parse(localStorage.getItem('cinevibe_rooms')||'[]'); return rooms.find(r=>r.roomId===roomId)||null; }

    const createRoomBtn = $('createRoom');
    const joinRoomBtn   = $('joinRoom');
    if (createRoomBtn) createRoomBtn.addEventListener('click', () => {
      if (!createRoomModal) return alert('Create Room UI not found.');
      if (crDisplayName) crDisplayName.value = localStorage.getItem('cinevibe_displayName') || '';
      if (crRoomName) crRoomName.value = '';
      if (crRoomId) crRoomId.value = randomRoomId();
      createRoomModal.style.display = 'flex';
    });
    if (joinRoomBtn) joinRoomBtn.addEventListener('click', () => {
      if (!joinRoomModal) return alert('Join Room UI not found.');
      if (jrDisplayName) jrDisplayName.value = localStorage.getItem('cinevibe_displayName') || '';
      if (jrRoomId) jrRoomId.value = '';
      joinRoomModal.style.display = 'flex';
    });
    if (createRoomClose) createRoomClose.addEventListener('click', () => { if (createRoomModal) createRoomModal.style.display='none'; });
    if (joinRoomClose)   joinRoomClose.addEventListener('click',   () => { if (joinRoomModal)   joinRoomModal.style.display='none'; });

    if (createRoomModal) createRoomModal.addEventListener('click', (e)=>{ if (e.target===createRoomModal) createRoomModal.style.display='none'; });
    if (joinRoomModal)   joinRoomModal.addEventListener('click',   (e)=>{ if (e.target===joinRoomModal)   joinRoomModal.style.display='none'; });

    
    if (crShareBtn) crShareBtn.addEventListener('click', async ()=>{
      const i = /** @type {HTMLInputElement|null} */ ($('crRoomId'));
      const id = i?.value?.trim(); if (!id) return alert('Generate a Room ID first.');
      const link = roomLink(id);
      if (navigator.share) { try { await navigator.share({ title:'Join my CineVibe Room', text:'Let’s watch together!', url:link }); return; } catch {}
      }
      const ok = await navigator.clipboard.writeText(link).then(()=>true).catch(()=>false);
      ok ? toast('Link copied to clipboard!') : alert(`Share this link:\n${link}`);
    });
    if (crJoinBtn) crJoinBtn.addEventListener('click', async ()=>{
      const displayName=/** @type {HTMLInputElement|null} */ ($('crDisplayName'))?.value?.trim();
      const roomName=/** @type {HTMLInputElement|null} */ ($('crRoomName'))?.value?.trim();
      const roomId=/** @type {HTMLInputElement|null} */ ($('crRoomId'))?.value?.trim();
      if (!displayName || !roomName || !roomId) return alert('Please fill all fields.');
      const room={roomId,roomName,host:displayName,createdAt:new Date().toISOString()};
      const saved=await saveRoomToFirebase(room); saveRoomLocal(room); localStorage.setItem('cinevibe_displayName',displayName||'');
      const url=new URL(location.href); url.searchParams.set('roomId',roomId); url.searchParams.set('name',encodeURIComponent(displayName||'')); history.replaceState(null,'',url.toString());
      alert(saved?'Room created & joined!':'Room created locally & joined!'); if (createRoomModal) createRoomModal.style.display='none';
    });
    if (jrJoinBtn) jrJoinBtn.addEventListener('click', async ()=>{
      const displayName=/** @type {HTMLInputElement|null} */ ($('jrDisplayName'))?.value?.trim();
      const roomId=(/** @type {HTMLInputElement|null} */ ($('jrRoomId'))?.value||'').trim().toUpperCase();
      if(!displayName || !roomId) return alert('Please enter display name and room ID.');
      let room=null;
      try{
        if (window.firebase?.db){
          const ref=window.firebase.collection(window.firebase.db,'rooms');
          const q=window.firebase.query(ref, window.firebase.orderBy('roomId'), window.firebase.limit(25));
          const snap=await window.firebase.getDocs(q);
          snap.forEach(doc=>{ if (doc.data()?.roomId===roomId) room=doc.data(); });
        }
      }catch{}
      if(!room) room=getRoomLocal(roomId) || {roomId,roomName:'CineVibe Room'};
      localStorage.setItem('cinevibe_displayName',displayName||'');
      const url=new URL(location.href); url.searchParams.set('roomId',roomId); url.searchParams.set('name',encodeURIComponent(displayName||'')); history.replaceState(null,'',url.toString());
      alert(`Joined ${room.roomName || 'room'}!`); if (joinRoomModal) joinRoomModal.style.display='none';
    });

    // ---------- Firebase history (optional) ----------
    async function saveSearchToHistory(mood){
      await withTry(async()=>{ if(window.firebase?.db){
        await window.firebase.addDoc(window.firebase.collection(window.firebase.db,'searchHistory'),
          { mood, timestamp: window.firebase.serverTimestamp(), userId: 'guest' });
      }});
    }
    async function loadSearchHistory(){
      await withTry(async()=>{
        if(!historyGrid) return;
        if(window.firebase?.db){
          const historyRef = window.firebase.collection(window.firebase.db,'searchHistory');
          const q = window.firebase.query(historyRef, window.firebase.orderBy('timestamp','desc'), window.firebase.limit(10));
          const snap = await window.firebase.getDocs(q);
          const history=[]; snap.forEach(doc=>{ const d=doc.data()||{}; history.push({ id:doc.id, mood:d.mood||'', timestamp:d.timestamp?.toDate?.()||new Date() });});
          displayHistory(history);
        } else displayHistory([]);
      });
    }
    function displayHistory(history){
      if(!historyGrid) return;
      historyGrid.innerHTML='';
      if(!history?.length){ historyGrid.innerHTML='<p style="text-align:center;color:var(--text-muted);">No search history yet</p>'; return; }
      history.forEach(item=>{
        const el=document.createElement('div'); el.className='history-item';
        el.onclick=()=>{ if(moodInput) moodInput.value=item.mood; handleSearch({preventDefault:noop}); toggleHistory(); };
        el.innerHTML=`<div class="history-mood">${item.mood}</div><div class="history-date">${item.timestamp instanceof Date ? item.timestamp.toLocaleDateString() : ''}</div>`;
        historyGrid.appendChild(el);
      });
    }
    function toggleHistory(){
      showingHistory=!showingHistory;
      if(!historySection || !trendingSection || !moodSuggestions || !moviesSection || !historyToggle) return;
      if(showingHistory){
        historySection.classList.add('show'); moviesSection.classList.remove('show');
        trendingSection.style.display='none'; moodSuggestions.style.display='none'; historyToggle.textContent='🎬 Movies'; loadSearchHistory();
      } else {
        historySection.classList.remove('show'); trendingSection.style.display='block'; moodSuggestions.style.display='block';
        historyToggle.textContent='📚 History'; if(currentMovies.length>0) moviesSection.classList.add('show');
      }
    }

    // ---------- Home rows (trending/now/upcoming) ----------
    function renderRow({title,containerId,movies}){
      if (!movies || movies.length === 0) return;
      let section=$(containerId);
      if(!section){
        section=document.createElement('section'); section.id=containerId; section.className='trending-section';
        section.innerHTML=`<h2 class="section-title">${title}</h2><div class="trending-grid"></div>`;
        (document.querySelector('.container')||document.body).appendChild(section);
      }
      const grid = section.querySelector('.trending-grid'); if(!grid) return;
      grid.innerHTML='';
      (movies||[]).slice(0,12).forEach((m,i)=>{
        const card=document.createElement('div'); card.className='trending-card'; card.style.animationDelay=`${i*0.07}s`;
        card.onclick=()=>openMovieModal(m);
        const rating=Number.isFinite(m?.rating)?Number(m.rating).toFixed(1):'—';
        card.innerHTML=`<img src="${m.poster||'/placeholder-movie.jpg'}" alt="${m.title}" class="trending-poster" loading="lazy">
          <div class="trending-info"><h3 class="trending-title">${m.title}</h3><p class="trending-rating">⭐ ${rating}</p></div>`;
        grid.appendChild(card);
      });
    }

    // NEW: Shuffle/Remix 50
    async function remix50() {
      if (isLoading) return;
      setLoading(true);
      try {
        const [all, nowp, upc] = await Promise.all([
          fetchJSON(`${API_BASE_URL}/trending/all`).catch(() => null),
          fetchJSON(`${API_BASE_URL}/now-playing`).catch(() => null),
          fetchJSON(`${API_BASE_URL}/upcoming`).catch(() => null),
        ]);

        const pool = [];
        const add = (arr) => (arr || []).forEach(m => m?.id && pool.push(m));
        if (all?.success) { add(all.hollywood); add(all.bollywood); add(all.anime); }
        if (nowp?.success) { add(nowp.us); add(nowp.in); }
        if (upc?.success) { add(upc.hollywood); add(upc.bollywood); add(upc.anime); }

        const byId = new Map();
        pool.forEach(m => { if (!byId.has(m.id)) byId.set(m.id, m); });
        const unique = Array.from(byId.values());

        for (let i = unique.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [unique[i], unique[j]] = [unique[j], unique[i]];
        }

        const pick = unique.slice(0, 70); // some slack for 404s
        const detailPromises = pick.map(m =>
          fetchJSON(`${API_BASE_URL}/details/${encodeURIComponent(m.id)}`).catch(() => null)
        );
        const detailed = (await Promise.all(detailPromises))
          .map(x => x?.movie)
          .filter(Boolean);

        const finalList = detailed.filter(m => (m.rating || 0) > 5.0).slice(0, 50);

        if (!finalList.length) { alert('Could not assemble a remix right now. Try again.'); return; }

        currentMovies = finalList;
        displayMovies(currentMovies);
        if (moviesTitle) moviesTitle.textContent = `🎲 Shuffle Mix (50) — Hollywood + Bollywood + Anime`;
        hideHomeSections();
        if (moviesSection) moviesSection.classList.add('show');
      } catch (e) {
        console.error('Remix error:', e);
        alert('Remix failed. Please try again.');
      } finally {
        setLoading(false);
      }
    }

    // Load and render all home rows, including Anime
    async function loadHomeRows(){
      try{
        const t = await fetchJSON(`${API_BASE_URL}/trending/all`).catch(()=>null);
        if(t?.success){
          renderRow({title:'🔥 Trending – Hollywood', containerId:'rowTrendingUS', movies:t.hollywood});
          renderRow({title:'💥 Trending – Bollywood',  containerId:'rowTrendingIN', movies:t.bollywood});
          renderRow({title:'🍣 Trending – Anime',      containerId:'rowTrendingAnime', movies:t.anime});
        }

        const np = await fetchJSON(`${API_BASE_URL}/now-playing`).catch(()=>null);
        if(np?.success){
          renderRow({title:'🎟️ In Cinemas Now – US',   containerId:'rowNowUS', movies:np.us});
          renderRow({title:'🎬 In Cinemas Now – India', containerId:'rowNowIN', movies:np.in});
        }

        const up = await fetchJSON(`${API_BASE_URL}/upcoming`).catch(()=>null);
        if(up?.success){
          renderRow({title:'⏳ Upcoming – Hollywood', containerId:'rowUpcomingUS', movies:up.hollywood});
          renderRow({title:'🌟 Upcoming – Bollywood', containerId:'rowUpcomingIN', movies:up.bollywood});
          renderRow({title:'🎌 Upcoming – Anime',     containerId:'rowUpcomingAnime', movies:up.anime});
        }
      }catch(e){ console.error('Home rows load error:',e); }
    }

    // ---------- Trending (simple top grid) ----------
    async function loadTrendingMovies(){
      try{
        const data=await fetchJSON(`${API_BASE_URL}/trending`);
        if(data?.success && Array.isArray(data.movies)) displayTrendingMovies(data.movies.slice(0,8));
      }catch(err){ console.error('Failed to load trending movies:',err); }
    }
    function displayTrendingMovies(movies){
      if(!trendingGrid) return; trendingGrid.innerHTML='';
      (movies||[]).forEach((movie,i)=>{
        const card=document.createElement('div'); card.className='trending-card'; card.style.animationDelay=`${Math.min(i*0.1,5)}s`;
        card.onclick=()=>openMovieModal(movie);
        const rating=Number.isFinite(movie?.rating)?Number(movie.rating).toFixed(1):'—';
        card.innerHTML=`<img src="${movie?.poster||'/placeholder-movie.jpg'}" alt="${movie?.title||'Movie'}" class="trending-poster" loading="lazy">
          <div class="trending-info"><h3 class="trending-title">${movie?.title||''}</h3><p class="trending-rating">⭐ ${rating}</p></div>`;
        trendingGrid.appendChild(card);
      });
    }

    // ---------- Search ----------
    // Modified to require Supabase session: if no session, open auth modal and hold pending mood.
    async function handleSearch(e){
      if (e?.preventDefault) e.preventDefault();
      if (isLoading) return;
      const mood = moodInput?.value?.trim(); if(!mood) return;

      // Check supabase session
      try {
        const { data: { session } } = await window.supabase.auth.getSession();
        if (!session) {
          // open auth modal and store pending mood
          if (window.CineVibeAuth && typeof window.CineVibeAuth.showAuthModalForMood === 'function') {
            window.CineVibeAuth.showAuthModalForMood(mood);
            return;
          } else {
            alert('Please sign in to search movies.');
            return;
          }
        }
      } catch (err) {
        console.warn('Auth check failed:', err);
        // fallback: force auth modal
        if (window.CineVibeAuth && typeof window.CineVibeAuth.showAuthModalForMood === 'function') {
          window.CineVibeAuth.showAuthModalForMood(mood);
          return;
        }
      }

      if (!bgMusicEnabled) { await enableBgMusic(); if (musicToggleBtn) musicToggleBtn.textContent='🔊 Music: On'; }
      setMoodMusicFromText(mood);

      setLoading(true);
      try{
        const data = await fetchJSON(`${API_BASE_URL}/recommend`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ mood })
        });
        if(!data?.movies) throw new Error(data?.error || 'Failed to get recommendations');

        currentMovies = data.movies;
        displayMovies(currentMovies);
        if (moviesTitle) moviesTitle.textContent = `Movies for "${mood}"`;
        await saveSearchToHistory(mood);

        if (showingHistory) toggleHistory();
        hideHomeSections();
        if (moviesSection) moviesSection.classList.add('show');
      }catch(err){
        console.error('Search error:',err);
        alert('Failed to get movie recommendations. Please try again.');
      }finally{ setLoading(false); }
    }

    // ---------- Loading UI ----------
    function setLoading(loading){
      isLoading=!!loading;
      if (loadingScreen) loadingScreen.style.display = loading ? 'flex' : 'none';
      if (searchButton){
        searchButton.disabled = loading;
        searchButton.dataset.origText = searchButton.dataset.origText || searchButton.textContent || 'Find Movies';
        searchButton.textContent = loading ? 'Searching...' : (searchButton.dataset.origText || 'Find Movies');
      }
      if (loading) startLoadingAnimation();
    }
    function startLoadingAnimation(){
      const dotsEl = $('loadingDots'); if(!dotsEl) return;
      let dots=''; const it=setInterval(()=>{ if(!isLoading){ clearInterval(it); return; } dots=dots.length>=3?'':dots+'.'; dotsEl.textContent=dots; },500);
    }

    // ---------- Movies grid ----------
    function displayMovies(movies){
      if(!moviesGrid) return; moviesGrid.innerHTML='';
      (movies||[]).forEach((m,i)=> moviesGrid.appendChild(createMovieCard(m,i)));
    }
    function createMovieCard(movie,index){
      const card=document.createElement('div'); card.className='movie-card'; card.style.animationDelay=`${Math.min(index*0.1,5)}s`;
      card.onclick=()=>openMovieModal(movie);
      const platforms=(movie?.ottPlatforms||[]).filter(p=>p?.available).slice(0,3).map(p=>`<span class="platform-badge">${p.name}</span>`).join('');
      card.innerHTML=`<img src="${movie?.poster||'/placeholder-movie.jpg'}" alt="${movie?.title||'Movie'}" class="movie-poster" loading="lazy">
        <div class="movie-info"><h3 class="movie-title">${movie?.title||''}</h3><p class="movie-year">${toYear(movie?.releaseDate)}</p><div class="movie-platforms">${platforms}</div></div>`;
      return card;
    }

   // ---------- Modal + trailer + MORE LIKE THIS ----------
    function renderMoreLikeThisSkeleton(container){
      container.innerHTML = `
        <h3 style="margin:1.5rem 0 .75rem;color:var(--accent-cyan);">More Like This</h3>
        <div id="moreLikeGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;"></div>
      `;
    }

    async function loadMoreLikeThis(id){
      const host = $('moreLikeHost'); if (!host) return;
      renderMoreLikeThisSkeleton(host);

      const grid = $('moreLikeGrid'); if (!grid) return;
      grid.innerHTML = `<div style="opacity:.6">Loading…</div>`;

      const data = await fetchJSON(`${API_BASE_URL}/recommendations/${encodeURIComponent(id)}`).catch(()=>null);
      const movies = data?.movies || [];
      grid.innerHTML = '';

      if (!movies.length) {
        grid.innerHTML = `<div style="opacity:.6">No similar titles found right now.</div>`;
        return;
      }

      movies.forEach(m => {
        const card = document.createElement('div');
        card.className = 'morelike-card';
        card.style.cssText = 'cursor:pointer;border-radius:.5rem;overflow:hidden;background:#1b1b1f;border:1px solid var(--border-color);';
        card.innerHTML = `
          <img src="${m.poster || '/placeholder-movie.jpg'}" alt="${m.title}" style="width:100%;height:200px;object-fit:cover;display:block">
          <div style="padding:.5rem .6rem;">
            <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${m.title}</div>
            <div style="font-size:.85rem;opacity:.8">⭐ ${Number.isFinite(m.rating)?Number(m.rating).toFixed(1):'—'} · ${toYear(m.releaseDate)}</div>
          </div>
        `;
        card.addEventListener('click', () => showDetailsById(m.id));
        grid.appendChild(card);
      });
    }

    function openMovieModal(movie){
      const modalContent=$('modalContent'); if(!movieModal || !modalContent) return;
      pauseBgForTrailer();

      const platforms=(movie?.ottPlatforms||[]).map(p=>`
        <div style="display:flex;align-items:center;justify-content:space-between;padding:.75rem;border:1px solid ${p?.available?'var(--primary-start)':'var(--border-color)'};border-radius:.5rem;margin-bottom:.5rem;background:${p?.available?'rgba(200,50,255,0.1)':'var(--bg-secondary)'};">
          <span style="color:${p?.available?'var(--text-primary)':'var(--text-secondary)'};">${p?.name||''}</span>
          ${p?.available && p?.url ? `<a href="${p.url}" target="_blank" rel="noopener noreferrer" style="color:var(--accent-cyan);text-decoration:none;font-weight:600;">Watch</a>`:''}
        </div>`).join('');
      const trailerSrc=(()=>{ if(!movie?.trailerUrl) return ''; const url=new URL(movie.trailerUrl,location.href); if(!url.searchParams.has('enablejsapi')) url.searchParams.set('enablejsapi','1'); return url.toString(); })();
      const rating=Number.isFinite(movie?.rating)?Number(movie.rating).toFixed(1):'—';
      const hasRuntime=Number.isFinite(movie?.runtime); const hours=hasRuntime?Math.floor(Number(movie.runtime)/60):0; const mins=hasRuntime?Number(movie.runtime)%60:0;

      modalContent.innerHTML = `
        <button class="modal-close" id="modalClose">&times;</button>
        ${movie?.backdrop ? `<img src="${movie.backdrop}" style="width:100%;height:300px;object-fit:cover;border-radius:1rem 1rem 0 0;">`:''}
        <div class="modal-content-inner" style="padding:2rem;">
          <h2 style="font-family:'Space Grotesk',sans-serif;font-size:2rem;margin-bottom:1rem;background:var(--gradient-primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">${movie?.title||''}</h2>
          <div style="display:flex;gap:1rem;margin-bottom:1rem;color:var(--text-secondary);">
            <span style="color:var(--accent-green);">⭐ ${rating}</span>
            <span>📅 ${toYear(movie?.releaseDate)}</span>
            ${hasRuntime?`<span>⏱ ${hours}h ${mins}m</span>`:''}
          </div>
          <p style="line-height:1.6;margin-bottom:1.25rem;color:var(--text-secondary);">${movie?.overview||''}</p>

          <!-- More Like This host -->
          <div id="moreLikeHost" style="margin:1rem 0 1.75rem;"></div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem;">
            <div>
              <h3 style="margin-bottom:1rem;color:var(--accent-cyan);">Genres</h3>
              <div style="display:flex;flex-wrap:wrap;gap:.5rem;">
                ${(movie?.genres||[]).map(g=>`<span style="padding:.25rem .75rem;background:var(--gradient-primary);border-radius:1rem;font-size:.8rem;color:white;">${g}</span>`).join('')}
              </div>
              ${movie?.director?`<h3 style="margin:1rem 0 .5rem;color:var(--accent-cyan);">Director</h3><p style="color:var(--text-secondary);">${movie.director}</p>`:''}
            </div>
            <div>
              <h3 style="margin-bottom:1rem;color:var(--accent-cyan);">Available On</h3>
              ${platforms}
            </div>
          </div>

          ${movie?.trailerUrl?`
            <div style="margin-top:2rem;">
              <h3 style="margin-bottom:1rem;color:var(--accent-cyan);">Trailer</h3>
              <iframe id="cvTrailer" src="${trailerSrc}" width="100%" height="300" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen style="border-radius:.5rem;border:1px solid var(--border-color);"></iframe>
            </div>`:''}
        </div>`;

      const closeBtn=$('modalClose'); if(closeBtn) closeBtn.addEventListener('click', closeModal, {once:true});
      movieModal.addEventListener('click', (e)=>{ if(e.target===movieModal) closeModal(); }, {once:true});
      movieModal.style.display='flex';

      // load “more like this”
      loadMoreLikeThis(movie.id);
    }

    function stopAllMediaInModal(){
      const modalContent=$('modalContent'); if(!modalContent) return;
      modalContent.querySelectorAll('video').forEach(v=>{ try{ v.pause(); v.currentTime=0; }catch{} });
      modalContent.querySelectorAll('iframe').forEach(frame=>{
        const src=frame.getAttribute('src'); if(!src) return;
        try{ frame.contentWindow?.postMessage(JSON.stringify({event:'command',func:'stopVideo',args:[]}), '*'); }catch{}
        frame.setAttribute('src','about:blank');
      });
    }
    function closeModal(){
      if(!movieModal) return;
      stopAllMediaInModal();
      movieModal.style.display='none';
      resumeBgAfterTrailer();
    }


    // ---------- BG Music Engine ----------
    let bgAudio=null, bgMusicEnabled=false, lastTheme=null;
    const BG_MUSIC = {
      romantic:'/music/Fall-In-Love-chosic.com_.mp3',
      sad:'/music/scott-buckley-moonlight(chosic.com).mp3',
      suspense:'/music/Hidden-Agenda(chosic.com).mp3',
      horror:'/music/Incantation-chosic.com_.mp3',
      comedy:'/music/Monkeys-Spinning-Monkeys(chosic.com).mp3',
      action:'/music/Last-Call-chosic.com_.mp3',
      scifi:'/music/suspense-sci-fi-underscore-music-loop-300215.mp3',
      chill:'/music/Heart-Of-The-Ocean(chosic.com).mp3',
      upbeat:'/music/HEROICCC(chosic.com).mp3',
    };
    function pickThemeFromText(txt){
      const t=(txt||'').toLowerCase();
      if (/(romance|romantic|love|sapphic|heartwarming|tearjerker|kiss|date)/.test(t)) return 'romantic';
      if (/(sad|melancholy|tragic|cry|breakup|lonely|somber)/.test(t)) return 'sad';
      if (/(suspense|thrill|mystery|twist|mind-?bending|tense|noir|detective)/.test(t)) return 'suspense';
      if (/(horror|scary|terrifying|haunt|slasher|possession|demonic)/.test(t)) return 'horror';
      if (/(comedy|funny|laugh|quirky|sitcom|rom-?com)/.test(t)) return 'comedy';
      if (/(action|fight|battle|war|chase|adrenaline|superhero)/.test(t)) return 'action';
      if (/(sci[- ]?fi|science fiction|space|cyberpunk|futur)/.test(t)) return 'scifi';
      if (/(feel[- ]?good|uplifting|happy|optimistic|wholesome|party)/.test(t)) return 'upbeat';
      if (/(chill|slice of life|calm|cozy|comfort|lofi|cult classic|underground)/.test(t)) return 'chill';
      return 'chill';
    }
    function ensureBgAudio(){ if(bgAudio) return bgAudio; bgAudio=new Audio(); bgAudio.loop=true; bgAudio.volume = musicVolume ? Number(musicVolume.value) : 0.25; return bgAudio; }
    async function setMoodMusicFromText(txt){ const theme=pickThemeFromText(txt); await setBgMusicTheme(theme); }
    async function setBgMusicTheme(theme){
      try{ ensureBgAudio(); const src=BG_MUSIC[theme]; if(!src) return;
        if(lastTheme===theme && !bgAudio.paused) return;
        const absSrc=new URL(src,location.href).toString();
        if(bgAudio.src!==absSrc){ bgAudio.src=absSrc; bgAudio.load(); }
        lastTheme=theme;
        if(bgMusicEnabled){ await bgAudio.play().catch(()=>{}); }
      }catch(e){ console.warn('BG music error:',e); }
    }
    async function enableBgMusic(){ bgMusicEnabled=true; ensureBgAudio(); try{ await bgAudio.play(); }catch{} }
    function disableBgMusic(){ bgMusicEnabled=false; if(bgAudio){ try{ bgAudio.pause(); }catch{} } }
    function pauseBgForTrailer(){ if(bgAudio && !bgAudio.paused){ try{ bgAudio.pause(); }catch{} } }
    async function resumeBgAfterTrailer(){ if(bgAudio && bgMusicEnabled){ try{ await bgAudio.play(); }catch{} } }

    if (musicToggleBtn) {
      musicToggleBtn.addEventListener('click', async () => {
        if (!bgMusicEnabled) { await enableBgMusic(); musicToggleBtn.textContent = '🔊 Music: On'; }
        else { disableBgMusic(); musicToggleBtn.textContent = '🔇 Music: Off'; }
      });
    }
    if (musicVolume) musicVolume.addEventListener('input', () => { ensureBgAudio(); bgAudio.volume = Number(musicVolume.value); });

    // ---------- Events / Init ----------
    if (searchForm) searchForm.addEventListener('submit', handleSearch);
    if (modalCloseBtn) modalCloseBtn.addEventListener('click', closeModal);
    if (historyToggle) historyToggle.addEventListener('click', toggleHistory);
    if (shuffleBtn) shuffleBtn.addEventListener('click', remix50);  // << NEW

    suggestionButtons.forEach((button) => {
      button.addEventListener('click', (e) => {
        const btn = /** @type {HTMLElement} */ (e.currentTarget);
        const mood = btn?.dataset?.mood || '';
        if (moodInput) moodInput.value = mood;
        handleSearch(e);
      });
    });

    if (movieModal) {
      movieModal.addEventListener('click', (e) => { if (e.target === movieModal) closeModal(); });
    }

    if (logoHome) {
      logoHome.style.cursor = 'pointer';
      logoHome.addEventListener('click', () => { window.location.reload(); });
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (movieModal && movieModal.style.display === 'flex') closeModal();
        if (createRoomModal && createRoomModal.style.display === 'flex') createRoomModal.style.display = 'none';
        if (joinRoomModal && joinRoomModal.style.display === 'flex') joinRoomModal.style.display = 'none';
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      loadTrendingMovies();
      loadSearchHistory();
      loadHomeRows();
    });

    console.log('🎬 CineVibe loaded! Ready to find your perfect vibe.');
  })();
  </script>
</body>
</html>
